---
- name: Install Apache + mod_php and deploy single-file PHP app (all-in-one, fixed)
  hosts: webserver
  become: yes
  vars:
    index_path: /var/www/html/index.php
    success_marker: "APPLICATION_INSTALL_SUCCESS"

    # Database settings - in production pass db_password via AWX credentials/extra-vars
    db_host: "192.168.100.151"
    db_name: "lampdb"
    db_user: "lampuser"
    db_password: "lamppass"

    php_pkg: "php8.3"
    libapache_php_pkg: "libapache2-mod-php8.3"
    php_mysql_pkg: "php8.3-mysql"

  tasks:
    - name: Refresh apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Apache + mod_php + php-mysql
      apt:
        name:
          - apache2
          - "{{ php_pkg }}"
          - "{{ libapache_php_pkg }}"
          - "{{ php_mysql_pkg }}"
        state: present

    - name: Remove default Apache index.html (if present)
      file:
        path: /var/www/html/index.html
        state: absent

    - name: Ensure mpm_event is disabled and mpm_prefork + php8.3 are enabled (mod_php)
      shell: |
        # disable event MPM if present
        if a2query -m mpm_event >/dev/null 2>&1; then
          a2dismod mpm_event || true
        fi
        # enable prefork and php module (idempotent)
        a2enmod mpm_prefork || true
        a2enmod php8.3 || true
      register: mods_enable
      changed_when: (mods_enable.stdout | default('')) != ''
      failed_when: false
      notify: Restart apache

    - name: Ensure apache2 is started and enabled
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Deploy index.php with DB connection and success marker
      copy:
        dest: "{{ index_path }}"
        content: |
          <?php
          $db_host = "{{ db_host }}";
          $db_user = "{{ db_user }}";
          $db_pass = "{{ db_password }}";
          $db_name = "{{ db_name }}";

          function show($s){ echo htmlspecialchars($s); }

          echo "<!doctype html><html><head><meta charset='utf-8'><title>Simple LAMP App</title></head><body>";
          echo "<h1>Simple LAMP App</h1>";
          echo "<p>Server date/time: " . date('Y-m-d H:i:s') . "</p>";

          $conn = @new mysqli($db_host, $db_user, $db_pass, $db_name);
          if ($conn->connect_error) {
              echo "<div style='color:red;'>Database connection failed: " . htmlspecialchars($conn->connect_error) . "</div>";
          } else {
              $result = @$conn->query("SELECT NOW()");
              if ($result) {
                  $row = $result->fetch_row();
                  echo "<div style='color:green;'>Connected to MySQL at " . show($db_host) . "</div>";
                  echo "<p>" . show($row[0]) . "</p>";
                  $result->free();
              } else {
                  echo "<div style='color:orange;'>DB connected but query failed.</div>";
              }
              $conn->close();
          }
          echo "<div>Application installed successfully â€” APPLICATION_INSTALL_SUCCESS</div>";
          echo "</body></html>";
        owner: www-data
        group: www-data
        mode: '0644'
      notify: Restart apache

    - name: Ensure apache is reloaded (apply changes)
      service:
        name: apache2
        state: reloaded

  handlers:
    - name: Restart apache
      service:
        name: apache2
        state: restarted
