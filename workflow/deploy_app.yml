---
- name: Install Apache + PHP-FPM and deploy app page
  hosts: webserver
  become: yes
  vars:
    index_path: /var/www/html/index.php
    success_marker: "APPLICATION_INSTALL_SUCCESS"
    php_fpm_conf_path: /etc/apache2/conf-available/php-fpm.conf
    php_fpm_socket: /run/php/php8.3-fpm.sock   # adjust if your PHP version differs

  tasks:
    - name: Install Apache and PHP packages
      apt:
        name:
          - apache2
          - php
          - php-mysql
          - php8.3-fpm
        state: present

    - name: Enable Apache modules required for PHP-FPM
      ansible.builtin.shell: |
        a2enmod proxy proxy_fcgi setenvif || true
        a2dismod php8.3 || true
      args:
        warn: false
      register: apache_mods
      changed_when: >
        apache_mods.stdout is defined and
        ( 'enabled' in apache_mods.stdout.lower() or
          'already enabled' not in apache_mods.stdout.lower() ) 
      failed_when: false

    - name: Create php-fpm Apache config
      copy:
        dest: "{{ php_fpm_conf_path }}"
        content: |
          <IfModule proxy_fcgi_module>
              <FilesMatch \.php$>
                  SetHandler "proxy:unix:{{ php_fpm_socket }}|fcgi://localhost/"
              </FilesMatch>
          </IfModule>
      notify: Reload apache

    - name: Enable php-fpm Apache config
      ansible.builtin.shell: a2enconf php-fpm || true
      args:
        warn: false
      register: a2enconf_out
      changed_when: "'enabled' in (a2enconf_out.stdout | default(''))"
      failed_when: false

    - name: Deploy index.php with success marker and date/time
      copy:
        dest: "{{ index_path }}"
        content: |
          <?php
          echo "<!doctype html><html><head><meta charset='utf-8'><title>Simple LAMP App</title></head><body>";
          echo "<h1>Simple LAMP App</h1>";
          echo "<p>Server date/time: " . date('Y-m-d H:i:s') . "</p>";
          echo "<div>Application installed successfully â€” {{ success_marker }}</div>";
          echo "</body></html>";
        owner: www-data
        group: www-data
        mode: '0644'
      notify: Restart apache

  handlers:
    - name: Reload apache
      service:
        name: apache2
        state: reloaded

    - name: Restart apache
      service:
        name: apache2
        state: restarted
