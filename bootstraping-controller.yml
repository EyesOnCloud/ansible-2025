---
- hosts: controller
  become: yes
  vars:
    token_file: join_token
  tasks:
    - name: Enable IPv4 forwarding for Kubernetes
      ansible.builtin.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
    - name: Resetting kubeadm
      shell: kubeadm reset -f
      register: output
    - name: Initialize the deployment of Kubernetes cluster
      shell: kubeadm init --pod-network-cidr=10.10.0.0/16
      register: output
    - name: "Configuration Files Setup"
      file:
        path: "$HOME/.kube"
        state: directory
    - name: "Copying Configuration File"
      copy:
        src: /etc/kubernetes/admin.conf
        dest: $HOME/.kube/config
        remote_src: yes
    - name: Change kubeconfig file permission
      file:
        path: $HOME/.kube/config
        owner: "{{ ansible_effective_user_id }}"
        group: "{{ ansible_effective_group_id }}"
    - name: "Downloading CNI Plugin"
      shell: |
        kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s-1.11.yaml
    - name: Storing Logs and Generated token for future purpose.
      local_action: copy content={{ output.stdout }} dest={{ token_file }}
      become: False
